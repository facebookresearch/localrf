apiVersion: batch/v1
kind: Job
metadata:
  name: 'uberlapse-train-mipnerf360'
spec:
  ttlSecondsAfterFinished: 60
  completions: 15
  parallelism: 15
  completionMode: Indexed
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: uberlapse
        resources:
          limits:
            cpu: 4
            memory: 96Gi
            nvidia.com/gpu: 1
        image: "dtr.thefacebook.com/ameuleman/mipnerf:latest"
        volumeMounts:
        - name: uberlapse
          mountPath: /mnt/uberlapse
        command:
          - "bash"
          - "-c"
          - |
            cd /mnt/uberlapse/ameuleman
            SCENES=(intermediate/M60 intermediate/Panther intermediate/Playground intermediate/Train advanced/Auditorium advanced/Ballroom advanced/Courtroom advanced/Museum train/Barn train/Caterpillar train/Church train/Courthouse train/Ignatius train/Meetingroom train/Truck)
            SCENE=${SCENES[$JOB_COMPLETION_INDEX]}
            SKIPS=(4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 3 3 3)
            SKIP=${SKIPS[$JOB_COMPLETION_INDEX]}
            SCENE_NAME=${SCENE}/skip_${SKIP}
            cd comparison/multinerf
            export XLA_PYTHON_CLIENT_MEM_FRACTION=0.87; python -m train --gin_configs=configs/360.gin --gin_bindings="Config.data_dir = '../../data/sequenced/${SCENE_NAME}'" --gin_bindings="Config.checkpoint_dir = '../../data/logs_eval/mipnerf360/${SCENE_NAME}/checkpoints'" --logtostderr
            export XLA_PYTHON_CLIENT_MEM_FRACTION=0.87; python -m render --gin_configs=configs/360.gin --gin_bindings="Config.data_dir = '../../data/sequenced/${SCENE_NAME}'" --gin_bindings="Config.checkpoint_dir = '../../data/logs_eval/mipnerf360/${SCENE_NAME}/checkpoints'" --gin_bindings="Config.render_dir = '../../data/logs_eval/mipnerf360/${SCENE_NAME}/render'" --gin_bindings="Config.render_path = False" --logtostderr
      volumes:
      - name: uberlapse
        persistentVolumeClaim:
          claimName: uberlapse
      priorityClassName: high
